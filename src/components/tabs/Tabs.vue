<template>
  <div>
    <div class="aui-tabs horizontal-tabs">
      <ul class="tabs-menu">
        <li class="menu-item" :key="tab.hash" v-for="tab in tabs">
          <a :ref="'tab_link_' + tab.hash" :href="'#' + tab.hash" v-html="tab.name"></a>
        </li>
      </ul>
      <slot></slot>
    </div>
  </div>
</template>

<script>
  export default {
    data() {
      return {
        tabs: []
      }
    },
    mounted() {
      this.updateTabs()
      AJS.tabs.setup()
    },
    updated(){
      this.updateTabs()
    },
    methods: {
      selectDefaultTab() {
        if (this.tabs.length){
          this.selectTab(this.tabs[0].hash)
        }
      },
      hasActiveTab(){
        let activeTab = $('.menu-item.active-tab')
        return activeTab.length && activeTab.is(':visible')
      },
      selectTab(tabHash) {
        Vue.nextTick(() => {
          const tabLinks = this.$refs[`tab_link_${tabHash}`]
          if (tabLinks && tabLinks.length) {
            let $tabLink = $(tabLinks[0])
            AJS.tabs.change($tabLink)
          }
        })
      },
      getTabs() {
        let tabs = []
        this.$slots.default.forEach(vNode => {
          if (vNode.componentInstance && vNode.componentOptions.tag === "va-tab") {
            let tab = vNode.componentInstance
            tabs.push(tab)
          }
        })
        return tabs
      },
      tabsChanged(newTabs){
        return  newTabs.length !== this.tabs.length
      },
      updateTabs() {
        let newTabs = this.getTabs()
        if (this.tabsChanged(newTabs)) {
          this.tabs = newTabs
          if (!this.hasActiveTab()){
            this.selectDefaultTab()
          }
        }
      }
    }
  }
</script>
